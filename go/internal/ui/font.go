package ui

import (
	"image"
	"image/color"

	"github.com/go-gl/gl/v4.1-core/gl"
)

// Font represents a bitmap font
type Font struct {
	textureID  uint32
	charWidth  int
	charHeight int
	cols       int
	rows       int
}

// Default 5x7 Font Data (Basic ASCII 32-127)
// Each byte represents a column of pixels. 5 bytes per char.
var fontData = []byte{
	// Space
	0x00, 0x00, 0x00, 0x00, 0x00,
	// !
	0x00, 0x00, 0x5F, 0x00, 0x00,
	// "
	0x00, 0x07, 0x00, 0x07, 0x00,
	// #
	0x14, 0x7F, 0x14, 0x7F, 0x14,
	// $
	0x24, 0x2A, 0x7F, 0x2A, 0x12,
	// %
	0x23, 0x13, 0x08, 0x64, 0x62,
	// &
	0x36, 0x49, 0x55, 0x22, 0x50,
	// '
	0x00, 0x05, 0x03, 0x00, 0x00,
	// (
	0x00, 0x1C, 0x22, 0x41, 0x00,
	// )
	0x00, 0x41, 0x22, 0x1C, 0x00,
	// *
	0x14, 0x08, 0x3E, 0x08, 0x14,
	// +
	0x08, 0x08, 0x3E, 0x08, 0x08,
	// ,
	0x00, 0x50, 0x30, 0x00, 0x00,
	// -
	0x08, 0x08, 0x08, 0x08, 0x08,
	// .
	0x00, 0x60, 0x60, 0x00, 0x00,
	// /
	0x20, 0x10, 0x08, 0x04, 0x02,
	// 0
	0x3E, 0x51, 0x49, 0x45, 0x3E,
	// 1
	0x00, 0x42, 0x7F, 0x40, 0x00,
	// 2
	0x42, 0x61, 0x51, 0x49, 0x46,
	// 3
	0x21, 0x41, 0x45, 0x4B, 0x31,
	// 4
	0x18, 0x14, 0x12, 0x7F, 0x10,
	// 5
	0x27, 0x45, 0x45, 0x45, 0x39,
	// 6
	0x3C, 0x4A, 0x49, 0x49, 0x30,
	// 7
	0x01, 0x71, 0x09, 0x05, 0x03,
	// 8
	0x36, 0x49, 0x49, 0x49, 0x36,
	// 9
	0x06, 0x49, 0x49, 0x29, 0x1E,
	// :
	0x00, 0x36, 0x36, 0x00, 0x00,
	// ;
	0x00, 0x56, 0x36, 0x00, 0x00,
	// <
	0x08, 0x14, 0x22, 0x41, 0x00,
	// =
	0x14, 0x14, 0x14, 0x14, 0x14,
	// >
	0x00, 0x41, 0x22, 0x14, 0x08,
	// ?
	0x02, 0x01, 0x51, 0x09, 0x06,
	// @
	0x32, 0x49, 0x79, 0x41, 0x3E,
	// A
	0x7E, 0x11, 0x11, 0x11, 0x7E,
	// B
	0x7F, 0x49, 0x49, 0x49, 0x36,
	// C
	0x3E, 0x41, 0x41, 0x41, 0x22,
	// D
	0x7F, 0x41, 0x41, 0x22, 0x1C,
	// E
	0x7F, 0x49, 0x49, 0x49, 0x41,
	// F
	0x7F, 0x09, 0x09, 0x09, 0x01,
	// G
	0x3E, 0x41, 0x49, 0x49, 0x7A,
	// H
	0x7F, 0x08, 0x08, 0x08, 0x7F,
	// I
	0x00, 0x41, 0x7F, 0x41, 0x00,
	// J
	0x20, 0x40, 0x41, 0x3F, 0x01,
	// K
	0x7F, 0x08, 0x14, 0x22, 0x41,
	// L
	0x7F, 0x40, 0x40, 0x40, 0x40,
	// M
	0x7F, 0x02, 0x0C, 0x02, 0x7F,
	// N
	0x7F, 0x04, 0x08, 0x10, 0x7F,
	// O
	0x3E, 0x41, 0x41, 0x41, 0x3E,
	// P
	0x7F, 0x09, 0x09, 0x09, 0x06,
	// Q
	0x3E, 0x41, 0x51, 0x21, 0x5E,
	// R
	0x7F, 0x09, 0x19, 0x29, 0x46,
	// S
	0x46, 0x49, 0x49, 0x49, 0x31,
	// T
	0x01, 0x01, 0x7F, 0x01, 0x01,
	// U
	0x3F, 0x40, 0x40, 0x40, 0x3F,
	// V
	0x1F, 0x20, 0x40, 0x20, 0x1F,
	// W
	0x3F, 0x40, 0x38, 0x40, 0x3F,
	// X
	0x63, 0x14, 0x08, 0x14, 0x63,
	// Y
	0x07, 0x08, 0x70, 0x08, 0x07,
	// Z
	0x61, 0x51, 0x49, 0x45, 0x43,
	// [
	0x00, 0x7F, 0x41, 0x41, 0x00,
	// \
	0x02, 0x04, 0x08, 0x10, 0x20,
	// ]
	0x00, 0x41, 0x41, 0x7F, 0x00,
	// ^
	0x04, 0x02, 0x01, 0x02, 0x04,
	// _
	0x40, 0x40, 0x40, 0x40, 0x40,
	// `
	0x00, 0x01, 0x02, 0x04, 0x00,
	// a
	0x20, 0x54, 0x54, 0x54, 0x78,
	// b
	0x7F, 0x48, 0x44, 0x44, 0x38,
	// c
	0x38, 0x44, 0x44, 0x44, 0x20,
	// d
	0x38, 0x44, 0x44, 0x48, 0x7F,
	// e
	0x38, 0x54, 0x54, 0x54, 0x18,
	// f
	0x08, 0x7E, 0x09, 0x01, 0x02,
	// g
	0x0C, 0x52, 0x52, 0x52, 0x3E,
	// h
	0x7F, 0x08, 0x04, 0x04, 0x78,
	// i
	0x00, 0x44, 0x7D, 0x40, 0x00,
	// j
	0x20, 0x40, 0x44, 0x3D, 0x00,
	// k
	0x7F, 0x10, 0x28, 0x44, 0x00,
	// l
	0x00, 0x41, 0x7F, 0x40, 0x00,
	// m
	0x7C, 0x04, 0x18, 0x04, 0x78,
	// n
	0x7C, 0x08, 0x04, 0x04, 0x78,
	// o
	0x38, 0x44, 0x44, 0x44, 0x38,
	// p
	0x7C, 0x14, 0x14, 0x14, 0x08,
	// q
	0x08, 0x14, 0x14, 0x18, 0x7C,
	// r
	0x7C, 0x08, 0x04, 0x04, 0x08,
	// s
	0x48, 0x54, 0x54, 0x54, 0x20,
	// t
	0x04, 0x3F, 0x44, 0x40, 0x20,
	// u
	0x3C, 0x40, 0x40, 0x20, 0x7C,
	// v
	0x1C, 0x20, 0x40, 0x20, 0x1C,
	// w
	0x3C, 0x40, 0x30, 0x40, 0x3C,
	// x
	0x44, 0x28, 0x10, 0x28, 0x44,
	// y
	0x0C, 0x50, 0x50, 0x50, 0x3C,
	// z
	0x44, 0x64, 0x54, 0x4C, 0x44,
	// {
	0x00, 0x08, 0x36, 0x41, 0x00,
	// |
	0x00, 0x00, 0x7F, 0x00, 0x00,
	// }
	0x00, 0x41, 0x36, 0x08, 0x00,
	// ~
	0x10, 0x08, 0x08, 0x10, 0x08,
}

// NewFont creates a new font
func NewFont() *Font {
	f := &Font{
		charWidth:  5,
		charHeight: 7,
		cols:       16,
		rows:       8,
	}
	f.loadTexture()
	return f
}

func (f *Font) loadTexture() {
	// Create texture atlas
	width := f.cols * (f.charWidth + 1)
	height := f.rows * (f.charHeight + 1)
	img := image.NewRGBA(image.Rect(0, 0, width, height))

	// Draw characters
	for i := 0; i < len(fontData)/5; i++ {
		charIdx := i + 32 // Start at space
		if charIdx > 126 {
			break
		}

		col := i % f.cols
		row := i / f.cols
		x := col * (f.charWidth + 1)
		y := row * (f.charHeight + 1)

		// Draw logic
		for c := 0; c < 5; c++ {
			byteVal := fontData[i*5+c]
			for r := 0; r < 8; r++ {
				if (byteVal>>r)&1 == 1 {
					img.Set(x+c, y+r, color.White)
				}
			}
		}
	}

	// Upload to OpenGL
	var texture uint32
	gl.GenTextures(1, &texture)
	gl.BindTexture(gl.TEXTURE_2D, texture)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST)
	gl.TexParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)

	gl.TexImage2D(
		gl.TEXTURE_2D,
		0,
		gl.RGBA,
		int32(width),
		int32(height),
		0,
		gl.RGBA,
		gl.UNSIGNED_BYTE,
		gl.Ptr(img.Pix),
	)

	f.textureID = texture
}

func (f *Font) Bind() {
	gl.BindTexture(gl.TEXTURE_2D, f.textureID)
}

func (f *Font) CharUV(char rune) (float32, float32, float32, float32) {
	if char < 32 || char > 126 {
		char = 63 // ?
	}
	i := int(char) - 32
	col := i % f.cols
	row := i / f.cols

	width := float32(f.cols * (f.charWidth + 1))
	height := float32(f.rows * (f.charHeight + 1))

	u1 := float32(col*(f.charWidth+1)) / width
	v1 := float32(row*(f.charHeight+1)) / height
	u2 := u1 + float32(f.charWidth)/width
	v2 := v1 + float32(f.charHeight)/height

	return u1, v1, u2, v2
}
